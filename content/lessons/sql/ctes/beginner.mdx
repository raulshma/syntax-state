# Common Table Expressions (CTEs)

Write cleaner, more readable queries!

##  What is a CTE?

A CTE is a named temporary result set:

```sql
WITH active_customers AS (
    SELECT * FROM customers WHERE status = 'active'
)
SELECT * FROM active_customers;
```

##  Why Use CTEs?

```sql
-- Without CTE: Hard to read
SELECT o.* FROM orders o
JOIN (SELECT * FROM customers WHERE status = 'active') c ON o.customer_id = c.id
WHERE o.total > (SELECT AVG(total) FROM orders);

-- With CTEs: Much clearer!
WITH active_customers AS (
    SELECT * FROM customers WHERE status = 'active'
),
avg_order AS (
    SELECT AVG(total) AS avg_total FROM orders
)
SELECT o.* FROM orders o
JOIN active_customers c ON o.customer_id = c.id
WHERE o.total > (SELECT avg_total FROM avg_order);
```

##  Basic Syntax

```sql
WITH cte_name AS (
    -- Your query here
)
SELECT * FROM cte_name;
```

##  Multiple CTEs

```sql
WITH
customer_totals AS (
    SELECT customer_id, SUM(total) AS lifetime_value
    FROM orders
    GROUP BY customer_id
),
vip_customers AS (
    SELECT * FROM customer_totals WHERE lifetime_value > 10000
)
SELECT c.name, v.lifetime_value
FROM customers c
JOIN vip_customers v ON c.id = v.customer_id;
```

##  CTE vs Subquery

| CTE                    | Subquery              |
| ---------------------- | --------------------- |
| Named, reusable        | Inline, one-time      |
| Easier to read         | Can be nested         |
| Good for complex logic | Good for simple cases |

##  Practical Example

```sql
WITH monthly_sales AS (
    SELECT
        DATE_TRUNC('month', order_date) AS month,
        SUM(total) AS revenue
    FROM orders
    GROUP BY DATE_TRUNC('month', order_date)
)
SELECT month, revenue,
    SUM(revenue) OVER (ORDER BY month) AS cumulative
FROM monthly_sales;
```

<ProgressCheckpoint section="ctes-complete" xpReward={25} />
