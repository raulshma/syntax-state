# Code-First Migrations

Imagine you're building with LEGO blocks, and you want to keep a record of every change you make - "First I built the base, then I added walls, then a roof." If you ever want to rebuild or see your history, you have perfect records! That's exactly what **migrations** do for your database.

---

## Section 1: Introduction to Migrations

### What Are Migrations?

Migrations are like **time travel for your database**! They:

- Track every change you make to your data models
- Can move your database forward (add new things)
- Can move your database backward (undo changes)
- Keep a history of all changes

> **Think of it this way:**
>
> Migrations are like save points in a video game. If you mess up, you can go back to an earlier save!

<MigrationVisualizer mode="beginner" />

## The Two Magic Commands

In EF Core, you mainly use two commands:

### 1. Add-Migration (Create a Save Point)

This command looks at your C# classes and figures out what changed:

```powershell
dotnet ef migrations add YourMigrationName
```

This is like taking a photo of your LEGO creation at this moment.

### 2. Update-Database (Apply Changes)

This command actually applies the migration to your database:

```powershell
dotnet ef database update
```

This is like building the LEGO changes for real!

## A Simple Example

<DotnetCodePreview
  title="Your First Migration"
  code={`// Step 1: You change your model
public class Blog
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Url { get; set; }  // NEW!
}

// Step 2: Create migration (in terminal)
// dotnet ef migrations add AddBlogUrl

// Step 3: Apply to database (in terminal)
// dotnet ef database update`}
steps={[
{
lineNumbers: [3, 4, 5, 6],
highlight: "Model change",
explanation: "You added a new Url property to your Blog class"
},
{
lineNumbers: [10],
highlight: "Record the change",
explanation: "This creates a migration file that describes adding the Url column"
},
{
lineNumbers: [13],
highlight: "Apply to database",
explanation: "This runs the migration and adds the Url column to your database"
}
]}
/>

## Why Not Just Change the Database Directly?

| Direct Database Changes | Using Migrations            |
| :---------------------- | :-------------------------- |
| Changes get lost        | Changes are tracked forever |
| Hard to undo            | Easy to roll back           |
| Team confusion          | Everyone stays in sync      |
| Production issues       | Safe deployment             |

### Installing EF Core Tools

Before you can use migrations, install the tools:

```powershell
# Install globally
dotnet tool install --global dotnet-ef

# Or update if already installed
dotnet tool update --global dotnet-ef

# Verify installation
dotnet ef --version
```

<ProgressCheckpoint section="intro-migrations" xpReward={8} />

---

## Section 2: Update Database

### The Update-Database Command

This command applies your migrations to the database:

```powershell
# Apply all pending migrations
dotnet ef database update

# See what SQL will be executed (without running it)
dotnet ef database update --verbose
```

### What Happens When You Update?

1. **Checks history** - Looks at which migrations are already applied
2. **Finds pending** - Identifies migrations that haven't run yet
3. **Runs Up methods** - Executes the Up() method for each pending migration
4. **Records history** - Marks migrations as applied in `__EFMigrationsHistory` table

<DotnetCodePreview
  title="Step-by-Step Example"
  code={`// 1. You have a Blog model
public class Blog
{
    public int Id { get; set; }
    public string Title { get; set; } = "";
}

// 2. Create initial migration
// dotnet ef migrations add InitialCreate

// 3. Apply to database
// dotnet ef database update
//  Database created!
//  Blogs table created!

// 4. Add a new property
public class Blog
{
    public int Id { get; set; }
    public string Title { get; set; } = "";
    public int Rating { get; set; }  // NEW!
}

// 5. Create migration for the change
// dotnet ef migrations add AddBlogRating

// 6. Apply the new migration
// dotnet ef database update
//  Rating column added to Blogs table!`}
  steps={[
    {
      lineNumbers: [9],
      highlight: "First migration",
      explanation: "Creates migration for initial database structure"
    },
    {
      lineNumbers: [12],
      highlight: "Create database",
      explanation: "Applies migration and creates the database"
    },
    {
      lineNumbers: [20],
      highlight: "Model change",
      explanation: "Added Rating property to Blog"
    },
    {
      lineNumbers: [24],
      highlight: "New migration",
      explanation: "Creates migration for the Rating column"
    },
    {
      lineNumbers: [27],
      highlight: "Update again",
      explanation: "Applies the new migration to add the column"
    }
  ]}
/>

### Undoing Migrations

If you made a mistake, you can roll back:

```powershell
# Go back to a specific migration
dotnet ef database update PreviousMigrationName

# Go back to the very beginning (empty database)
dotnet ef database update 0

# Remove the last migration (only if not applied yet!)
dotnet ef migrations remove
```

<InfoBox type="warning">
  **Warning:** Only use `migrations remove` if you haven't run `database update` yet! Once applied, create a new migration to undo changes.
</InfoBox>

<ProgressCheckpoint section="update-database" xpReward={9} />

---

## Section 3: Migration History

### The __EFMigrationsHistory Table

EF Core tracks which migrations have been applied in a special table:

```sql
-- This table is created automatically
SELECT * FROM __EFMigrationsHistory;

-- Shows something like:
-- MigrationId                    | ProductVersion
-- 20241214120000_InitialCreate  | 8.0.0
-- 20241214130000_AddBlogRating  | 8.0.0
```

### Understanding Migration Names

Migration names follow a pattern:

```
20241214120000_InitialCreate
│         │    │
│         │    └─ Your descriptive name
│         └────── Time (HHmmss)
└──────────────── Date (yyyyMMdd)
```

This ensures migrations are always in chronological order!

### Checking Migration Status

```powershell
# List all migrations and their status
dotnet ef migrations list

# Output shows:
# 20241214120000_InitialCreate (Applied)
# 20241214130000_AddBlogRating (Applied)
# 20241214140000_AddBlogUrl (Pending)
```

### Common Scenarios

#### Scenario 1: Fresh Database

```powershell
# Create database and apply all migrations
dotnet ef database update
```

#### Scenario 2: Existing Database

```powershell
# EF Core checks history and only applies new migrations
dotnet ef database update
```

#### Scenario 3: Team Member Pulls New Code

```powershell
# Pull code with new migrations
git pull

# Apply the new migrations
dotnet ef database update
```

## Quick Summary

- **Migrations** = Save points for your database structure
- **Add-Migration** = Creates a new save point
- **Update-Database** = Applies pending changes
- **__EFMigrationsHistory** = Tracks which migrations are applied
- Always create migrations when you change your models!
- Use `migrations list` to see status
- Use `database update 0` to reset database

<ProgressCheckpoint section="migration-history" xpReward={8} />
